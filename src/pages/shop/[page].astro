---
import Layout from '../../components/layouts/Layout.astro';
import ProductCard from '../../components/astro/ProductCard.astro';
import CategoryPill from '../../components/astro/CategoryPill.astro';
import { sanityClient, urlFor } from '@/lib/sanity';

// ---------- fetch unique categories ----------
const catsRaw = await sanityClient.fetch(
  `*[_type == "shopProduct"].category | order(@ asc)`
);
const categories = [...new Set(catsRaw)];
const topCategories = categories.slice(0, 7);

// ---------- dynamic routes ----------
export async function getStaticPaths() {
  const pageSize = 9;
  const allProducts = await sanityClient.fetch(
    `*[_type == "shopProduct"] | order(_createdAt desc) { id }`
  );
  const totalPages = Math.ceil(allProducts.length / pageSize);
  return Array.from({ length: totalPages }, (_, i) => i + 1)
              .map(page => ({ params: { page: page.toString() } }));
}

const pageParam = Astro.params.page;
const rawPage = pageParam ? Number(pageParam) : 1;
const activeCat = Astro.url.searchParams.get('cat') ?? 'All';

// ---------- fetch products ----------
const allProducts = await sanityClient.fetch(
  `*[_type == "shopProduct"] | order(_createdAt desc) {
     id, name, shortDescription, mainImage, category, tags, isNew
  }`
).then(list => list.map((p: any) => ({
  id: p.id,
  name: p.name,
  shortDescription: p.shortDescription,
  image: { href: urlFor(p.mainImage).width(600).quality(80).url() },
  category_1_text: p.category,
  tags: p.tags || [],
  isNew: p.isNew
})));

let list = activeCat === 'All' ? allProducts : allProducts.filter(p => p.category_1_text === activeCat);

const pageSize = 9;
const currentPage = Math.max(1, Math.min(rawPage, Math.ceil(list.length / pageSize)));
const start = (currentPage - 1) * pageSize;
const end = start + pageSize;
const pageProducts = list.slice(start, end);
const totalPages = Math.ceil(list.length / pageSize);

const title = activeCat === 'All' ? `Page ${currentPage} - All Products | Eliphany` : `Page ${currentPage} - ${activeCat} | Eliphany`;
const description = 'Browse skin-care supplements – contact us on WhatsApp for orders.';
---

<Layout {title} {description}>
  <section class="py-12 px-4 max-w-7xl mx-auto">
    <h1 class="text-4xl font-bold text-gray-900 mb-2">Shop - {activeCat}</h1>
    <p class="text-gray-600 mb-6">
      Showing {start + 1}–{Math.min(end, list.length)} of {list.length} results
      (Page {currentPage})
    </p>

    <!-- category filter -->
    <nav class="flex flex-wrap gap-2 mb-8 sticky top-20 bg-white/80 backdrop-blur z-10 py-3">
      <a
        href="/shop/1"
        class:list={[
          'px-3 py-1.5 text-sm rounded-full border',
          activeCat === 'All'
            ? 'bg-emerald-600 text-white border-emerald-600'
            : 'bg-white text-gray-700 border-gray-300 hover:border-emerald-400'
        ]}
      >
        All
      </a>
      {topCategories.map(cat => (
        <CategoryPill
          category={cat}
          large={false}
          href={`/shop/1?cat=${encodeURIComponent(cat)}`}
        />
      ))}
    </nav>

    <!-- grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 px-6">
      {pageProducts.map(p => <ProductCard product={p} />)}
    </div>

    <!-- pagination -->
    {totalPages > 1 && (
      <div class="flex items-center justify-between mt-10 text-sm">
        <a
          href={currentPage === 2 ? '/shop/1' : `/shop/${currentPage - 1}?cat=${encodeURIComponent(activeCat)}`}
          class:list={[
            'px-4 py-2 rounded-lg border',
            currentPage === 1
              ? 'bg-gray-100 text-gray-400 pointer-events-none'
              : 'bg-white text-gray-700 hover:border-emerald-400'
          ]}
          aria-disabled={currentPage === 1}
        >
          ← Previous
        </a>

        <span class="text-gray-600">
          Page {currentPage} of {totalPages}
        </span>

        <a
          href={`/shop/${currentPage + 1}?cat=${encodeURIComponent(activeCat)}`}
          class:list={[
            'px-4 py-2 rounded-lg border',
            currentPage === totalPages
              ? 'bg-gray-100 text-gray-400 pointer-events-none'
              : 'bg-white text-gray-700 hover:border-emerald-400'
          ]}
          aria-disabled={currentPage === totalPages}
        >
          Next →
        </a>
      </div>
    )}
  </section>
</Layout>