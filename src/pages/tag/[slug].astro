---
import Layout from '../../components/layouts/Layout.astro';
import ProductCard from '../../components/astro/ProductCard.astro';
import { getUniqueTags } from '@/utils/getUniqueTags';
import { slugify } from '@/utils/slugify';
import { filterByTag } from '@/utils/filterByTag';
import { sanityClient, urlFor } from '@/lib/sanity';

export async function getStaticPaths() {
  const allProducts = await sanityClient.fetch(
    `*[_type == "shopProduct"] { tags }`
  );
  const flatTags = allProducts.flatMap((p: any) => p.tags || []);
  const uniqueTags = [...new Set(flatTags)];
  return uniqueTags.map(t => ({ params: { slug: slugify(t) }, props: { tagName: t } }));
}

const { slug } = Astro.params;
const { tagName } = Astro.props;

const list = await sanityClient.fetch(
  `*[_type == "shopProduct" && $tag in tags] {
     id, name, shortDescription, mainImage, category, tags, isNew
   }`,
  { tag: tagName }
).then((prods: any[]) =>
  prods.map(p => ({
    id: p.id,
    name: p.name,
    shortDescription: p.shortDescription,
    image: { href: urlFor(p.mainImage).width(600).quality(80).url() },
    category_1_text: p.category,
    tags: p.tags || [],
    isNew: p.isNew
  }))
);

const title = `${tagName} Products | Eliphany`;
const description = `Explore products tagged ${tagName} – order via WhatsApp.`;
---

<Layout {title} {description}>
  <section class="py-12 px-4 max-w-7xl mx-auto">
    <nav class="text-sm text-gray-500 mb-4">
      <a href="/" class="hover:underline">Home</a>
      <span class="mx-2">/</span>
      <span class="text-gray-900">{tagName}</span>
    </nav>

    <h1 class="text-4xl font-bold text-gray-900 mb-2">{tagName}</h1>
    <p class="text-gray-600 mb-8">Products tagged under "{tagName}".</p>

    {list.length === 0 ? (
      <p class="text-gray-600">No products match this tag yet – check back soon!</p>
    ) : (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 px-6 gap-6">
        {list.map(p => <ProductCard product={p} />)}
      </div>
    )}
  </section>
</Layout>